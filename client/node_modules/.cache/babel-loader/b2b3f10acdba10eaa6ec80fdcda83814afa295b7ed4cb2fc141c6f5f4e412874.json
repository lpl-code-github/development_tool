{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport RunNewman from \"@/components/Newman/RunNewman\";\nimport NewmanTask from \"@/components/Newman/NewmanTask\";\nimport { getNewmanTasks, putNewmanTasks } from \"@/api/request\";\nexport default {\n  name: \"Newman\",\n  components: {\n    NewmanTask,\n    RunNewman\n  },\n  data() {\n    return {\n      taskCount: 0,\n      columns: [{\n        title: '名称',\n        width: 150,\n        dataIndex: 'name',\n        scopedSlots: {\n          customRender: 'name'\n        }\n      }, {\n        title: '描述',\n        width: 250,\n        dataIndex: 'description',\n        scopedSlots: {\n          customRender: 'description'\n        }\n      }, {\n        title: '状态',\n        width: 50,\n        dataIndex: 'status',\n        key: 'status',\n        scopedSlots: {\n          customRender: 'status'\n        }\n      }, {\n        title: '开始时间',\n        width: 100,\n        dataIndex: 'created_at',\n        key: 'created_at'\n      }, {\n        title: '结束时间',\n        width: 100,\n        dataIndex: 'updated_at',\n        key: 'updated_at'\n      }, {\n        title: 'Action',\n        width: 200,\n        dataIndex: '',\n        key: 'x',\n        scopedSlots: {\n          customRender: 'action'\n        }\n      }],\n      paginationConfig: {\n        defaultCurrent: 1,\n        defaultPageSize: 5\n      },\n      scriptData: [],\n      tableData: [],\n      cacheData: [],\n      filters: [],\n      filteredValue: [],\n      tagsFilterDropdownVisible: false,\n      openRunNewmanModelFlag: false,\n      openNewmanTaskModelFlag: false,\n      runTestFlag: false,\n      timer: null,\n      taskName: \"\",\n      // flag 代表任务打开与关闭\n      tempTaskLog: [{\n        name: \"关闭测试环境的报错信息\",\n        flag: false,\n        status: \"\",\n        index: 1\n      }, {\n        name: \"导入备份及恢复数据库的测试接口\",\n        flag: false,\n        status: \"\",\n        index: 2\n      }, {\n        name: \"切换到测试环境\",\n        flag: false,\n        status: \"\",\n        index: 3\n      }, {\n        name: \"执行newman测试命令\",\n        flag: false,\n        status: \"\",\n        index: 4\n      }],\n      taskLog: [],\n      currentTask: null,\n      editingKey: ''\n    };\n  },\n  watch: {\n    currentTask: {\n      handler: function (newVal, oldVal) {\n        if (this.currentTask.status !== \"success\") {}\n      },\n      // 深度观察监听\n      deep: true\n    }\n  },\n  created() {\n    this.getUnfinishedNewmanTasks();\n    this.getScriptData();\n  },\n  mounted() {\n    var currentTaskId = localStorage.getItem(\"run_postman_flag\");\n    if (currentTaskId == null) {\n      localStorage.setItem('run_postman_flag', \"0\");\n    }\n    this.getAllTaskList();\n    // if (this.timer == null) {\n    //   this.timer = setInterval(() => {\n    //     this.getUnfinishedNewmanTasks()\n    //   }, 3000);\n    // }\n  },\n\n  beforeDestroy() {\n    clearInterval(this.timer);\n  },\n  methods: {\n    onSearch(value) {\n      console.log(value);\n    },\n    handleChange(pagination, filters) {\n      var tagFilterChecked = filters.tags;\n      if (filters.tags.length === 0) {\n        this.tableData = this.scriptData;\n        return;\n      }\n      this.tableData = this.scriptData.filter(item => {\n        return item.tags.some(tag => tagFilterChecked.includes(tag.text));\n      });\n    },\n    getScriptData() {\n      this.scriptData = [{\n        id: 1,\n        name: 'John Brown',\n        created_at: 'New York No. 1 Lake Park',\n        updated_at: 'New York No. 1 Lake Park',\n        description: 'My name is John Brown, I am 32 years old, living in New York No. 1 Lake Park.'\n      }, {\n        id: 2,\n        name: 'Jim Green',\n        created_at: 'New York No. 1 Lake Park',\n        updated_at: 'New York No. 1 Lake Park',\n        description: 'My name is Jim Green, I am 42 years old, living in London No. 1 Lake Park.'\n      }, {\n        id: 3,\n        name: 'Joe Black',\n        created_at: 'New York No. 1 Lake Park',\n        updated_at: 'New York No. 1 Lake Park',\n        description: 'My name is Joe Black, I am 32 years old, living in Sidney No. 1 Lake Park.'\n      }, {\n        id: 4,\n        name: 'Joe Black',\n        created_at: 'New York No. 1 Lake Park',\n        updated_at: 'New York No. 1 Lake Park',\n        description: 'My name is Joe Black, I am 32 years old, living in Sidney No. 1 Lake Park.'\n      }];\n      this.tableData = this.scriptData;\n    },\n    openRunNewmanModel() {\n      this.openRunNewmanModelFlag = true;\n    },\n    openNewmanTaskModel() {\n      this.openNewmanTaskModelFlag = true;\n    },\n    getRunNewmanModelStatus(status) {\n      this.openRunNewmanModelFlag = status;\n    },\n    getNewmanModelTaskStatus(status) {\n      this.openNewmanTaskModelFlag = status;\n    },\n    getRunTaskObj(taskObj) {\n      if (taskObj != null) {\n        this.runTestFlag = true;\n        console.log(taskObj);\n      }\n    },\n    // 获取全部任务列表\n    getAllTaskList(params) {\n      if (params == null) {\n        params = \"\";\n      }\n      this.$request.getAllNewmanTasks(params).then(res => {\n        if (res.status === 200) {\n          this.backupList = res.data.data;\n          const dbFilters = [];\n          this.backupList.forEach(item => {\n            const existingTag = dbFilters.find(filter => filter.text === item.db_name);\n            if (!existingTag) {\n              dbFilters.push({\n                text: item.db_name,\n                value: item.db_name\n              });\n            }\n            item.key = item.id;\n          });\n          this.columns.forEach(item => {\n            if (item.key === 'db_name') {\n              item.filters = dbFilters;\n            }\n          });\n          this.tableData = this.backupList;\n          this.cacheData = this.tableData.map(item => ({\n            ...item\n          }));\n        }\n      });\n    },\n    // table编辑\n    handleChangeEdit(value, key, column) {\n      const newData = [...this.tableData];\n      const target = newData.find(item => key === item.key);\n      if (target) {\n        target[column] = value;\n        this.tableData = newData;\n      }\n    },\n    // 编辑表格基本信息\n    edit(key) {\n      const newData = [...this.tableData];\n      const target = newData.find(item => key === item.key);\n      this.editingKey = key;\n      if (target) {\n        target.editable = true;\n        this.tableData = newData;\n      }\n    },\n    save(key) {\n      const newData = [...this.tableData];\n      const newCacheData = [...this.cacheData];\n      const target = newData.find(item => key === item.key);\n      const targetCache = newCacheData.find(item => key === item.key);\n      if (target && targetCache) {\n        // 校验\n\n        let nameLength = target.name.length;\n        let descriptionLength = target.description.length;\n        if (!(nameLength >= 5 && length <= 50)) {\n          this.$message.warning(\"名称长度应该在5～50之间\");\n          return;\n        }\n        if (descriptionLength === 0) {\n          this.$message.warning(\"描述不能为空\");\n          return;\n        }\n        var param = {\n          data: {\n            id: target.id,\n            name: target.name,\n            description: target.description\n          }\n        };\n        this.$request.putNewmanTasks(param).then(res => {\n          if (res.status === 200) {\n            delete target.editable;\n            this.tableData = newData;\n            Object.assign(targetCache, target);\n            this.cacheData = newCacheData;\n            this.$message.success(\"更新成功\");\n          } else {\n            this.$message.error(\"更新失败\");\n          }\n        });\n      }\n      this.editingKey = '';\n    },\n    cancel(key) {\n      const newData = [...this.tableData];\n      const target = newData.find(item => key === item.key);\n      this.editingKey = '';\n      if (target) {\n        Object.assign(target, this.cacheData.find(item => key === item.key));\n        delete target.editable;\n        this.tableData = newData;\n      }\n    },\n    // 获取未完成的任务\n    getUnfinishedNewmanTasks() {\n      var param = \"?is_unfinished=true\";\n      this.$request.getNewmanTasks(param).then(async res => {\n        if (res.status === 200) {\n          var data = res.data.data;\n          if (data.length !== 0) {\n            var task = data[0];\n            this.currentTask = task;\n            this.taskName = task.name;\n            this.taskCount = 1;\n            if (task.log == null) {\n              var putParam = {\n                data: {\n                  log: this.tempTaskLog,\n                  id: task.id\n                }\n              };\n              this.$request.putNewmanTasksLog(putParam).then(res => {\n                if (res.status === 200) {\n                  if (res.data.data.log != null && res.data.data.log.length !== 0) {\n                    this.taskLog = res.data.data.log;\n                  } else {\n                    this.taskLog = [];\n                  }\n                } else {\n                  this.taskLog = [];\n                }\n              });\n            } else {\n              this.taskLog = task.log;\n              // start\n              if (task.status == null) {\n                await this.startPostmanTest(this.taskLog);\n              }\n            }\n          } else {\n            this.currentTask = null;\n            this.taskName = \"\";\n            this.taskCount = 0;\n            this.taskLog = [];\n          }\n        }\n        setTimeout(this.getUnfinishedNewmanTasks, 3000);\n      });\n    },\n    async startPostmanTest(taskLog) {\n      for (let i = 0; i < taskLog.length; i++) {\n        var item = taskLog[i];\n        if (item.flag === false) {\n          // 任务未开始\n          taskLog[i].flag = true; // 开始任务\n          // 执行任务\n          if (item.index === 1) {\n            // 关闭测试环境的报错信息\n            await this.$request.switchApi('test_env_error_message', false).then(async res => {\n              if (res.status === 200) {\n                // 关闭成功\n                taskLog[i].status = \"success\";\n                await this.modifyTaskLog(this.taskLog, null, this.currentTask.id);\n              } else {\n                taskLog[i].status = \"error\" + res.data.message;\n                await this.modifyTaskLog(this.taskLog, \"error\", this.currentTask.id);\n              }\n            });\n          } else if (item.index === 2) {\n            // 导入备份/恢复数据库的测试接口\n            await this.$request.switchApi('back_api', true).then(async res => {\n              if (res.status === 200) {\n                // 关闭成功\n                taskLog[i].status = \"success\";\n                await this.modifyTaskLog(this.taskLog, null, this.currentTask.id);\n              } else {\n                taskLog[i].status = \"error\" + res.data.message;\n                await this.modifyTaskLog(this.taskLog, \"error\", this.currentTask.id);\n              }\n            });\n          } else if (item.index === 3) {\n            // 切换到测试环境\n            await this.$request.switchApi('test_env', true).then(async res => {\n              if (res.status === 200) {\n                // 关闭成功\n                taskLog[i].status = \"success\";\n                await this.modifyTaskLog(this.taskLog, null, this.currentTask.id);\n              } else {\n                taskLog[i].status = \"error\" + res.data.message;\n                await this.modifyTaskLog(this.taskLog, \"error\", this.currentTask.id);\n              }\n            });\n          } else if (item.index === 4) {\n            // 执行postman测试，只执行一次\n            var currentTaskId = localStorage.getItem(\"run_postman_flag\");\n            if (currentTaskId != this.currentTask.id) {\n              const param = {\n                data: {\n                  task_id: this.currentTask.id\n                }\n              };\n              await this.$request.runNewman(param).then(async res => {\n                if (res.status === 200) {\n                  // 执行成功\n                  localStorage.setItem(\"run_postman_flag\", this.currentTask.id);\n                } else {\n                  taskLog[i].status = \"error\" + res.data.message;\n                  await this.modifyTaskLog(this.taskLog, \"error\", this.currentTask.id);\n                }\n              });\n            }\n          }\n          break;\n        }\n      }\n    },\n    // 更新日志及状态\n    async modifyTaskLog(log, status, id) {\n      var putParam = {\n        data: {\n          log: log,\n          status: status,\n          id: id\n        }\n      };\n      await this.$request.putNewmanTasksLog(putParam).then();\n    },\n    initTaskLog() {\n      this.taskLog = [...this.tempTaskLog];\n    }\n  }\n};","map":{"version":3,"names":["RunNewman","NewmanTask","getNewmanTasks","putNewmanTasks","name","components","data","taskCount","columns","title","width","dataIndex","scopedSlots","customRender","key","paginationConfig","defaultCurrent","defaultPageSize","scriptData","tableData","cacheData","filters","filteredValue","tagsFilterDropdownVisible","openRunNewmanModelFlag","openNewmanTaskModelFlag","runTestFlag","timer","taskName","tempTaskLog","flag","status","index","taskLog","currentTask","editingKey","watch","handler","newVal","oldVal","deep","created","getUnfinishedNewmanTasks","getScriptData","mounted","currentTaskId","localStorage","getItem","setItem","getAllTaskList","beforeDestroy","clearInterval","methods","onSearch","value","console","log","handleChange","pagination","tagFilterChecked","tags","length","filter","item","some","tag","includes","text","id","created_at","updated_at","description","openRunNewmanModel","openNewmanTaskModel","getRunNewmanModelStatus","getNewmanModelTaskStatus","getRunTaskObj","taskObj","params","$request","getAllNewmanTasks","then","res","backupList","dbFilters","forEach","existingTag","find","db_name","push","map","handleChangeEdit","column","newData","target","edit","editable","save","newCacheData","targetCache","nameLength","descriptionLength","$message","warning","param","Object","assign","success","error","cancel","task","putParam","putNewmanTasksLog","startPostmanTest","setTimeout","i","switchApi","modifyTaskLog","message","task_id","runNewman","initTaskLog"],"sources":["src/views/Newman.vue"],"sourcesContent":["<template>\n  <div class=\"my-newman\">\n    <RunNewman @newmanTask=\"getRunTaskObj\" @updateModelStatus=\"getRunNewmanModelStatus\"\n               :open-flag=\"openRunNewmanModelFlag\"></RunNewman>\n    <NewmanTask :task-log=\"taskLog\" :taskName=\"taskName\" @updateModelStatus=\"getNewmanModelTaskStatus\"\n                :open-flag=\"openNewmanTaskModelFlag\"></NewmanTask>\n    <div class=\"my-n-button\">\n      <a-input-search placeholder=\"输入脚本名或描述搜索\" style=\"width: 200px\" @search=\"onSearch\"/>\n      <div>\n        <a-button type=\"primary\" @click=\"openRunNewmanModel\" style=\"margin-right: 10px\">\n          创建任务\n        </a-button>\n        <a-badge :count=\"taskCount\" style=\"margin-right: 10px\">\n          <a-button @click=\"openNewmanTaskModel\">\n            任务详情\n            <a-icon v-if=\"taskCount !== 0\" type=\"sync\" spin/>\n          </a-button>\n        </a-badge>\n        <!--        <a-button @click=\"openNewmanLogModel\" style=\"margin-right: 10px\">-->\n        <!--          日志-->\n        <!--        </a-button>-->\n      </div>\n    </div>\n    <div class=\"my-n-table\">\n      <a-table\n          :columns=\"columns\"\n          :data-source=\"tableData\"\n          @change=\"handleChange\"\n          :pagination=\"paginationConfig\"\n      >\n\n          <template\n              v-for=\"col in ['name','description']\"\n              :slot=\"col\"\n              slot-scope=\"text, record, index\"\n          >\n          <div :key=\"col\">\n            <a-input\n                :type=\"col=== 'description'?'textarea':''\"\n                rows=\"1\"\n                v-if=\"record.editable\"\n                style=\"margin: -5px 0\"\n                :value=\"text\"\n                @change=\"e => handleChangeEdit(e.target.value, record.key, col)\"\n            />\n            <template v-else>\n              {{ text === \"\" || text === null ? \"/\" : text }}\n            </template>\n          </div>\n        </template>\n        <span slot=\"status\" slot-scope=\"status\">\n          <a-tag\n              :color=\"status === 'success'? '#1ba81e' :'#d92f09' \"\n          >\n            {{ status === 'success'? '成功' :'失败'  }}\n          </a-tag>\n        </span>\n        <template slot=\"action\" slot-scope=\"text, record, index\">\n          <div class=\"editable-row-operations\">\n              <span v-if=\"record.editable\">\n                <a style=\"color: #5f92ef\" @click=\"() => save(record.key)\">更新</a>\n                <a-divider type=\"vertical\" style=\"background-color: #a8a7a7!important;\"/>\n                <a-popconfirm title=\"确定取消吗？\" @confirm=\"() => cancel(record.key)\">\n                  <a style=\"color: #5f6062\">取消</a>\n                </a-popconfirm>\n              </span>\n            <span v-else>\n         <a style=\"color: #5f92ef\" :disabled=\"editingKey !== ''\" @click=\"() => edit(record.key)\">编辑</a>\n              <a-divider type=\"vertical\" style=\"background-color: #a8a7a7!important;\"/>\n          <a style=\"color: #286d9f\">Html报告</a>\n          <a-divider type=\"vertical\" style=\"background-color: #a8a7a7!important;\"/>\n          <a style=\"color: #16750c\">Excel报告</a>\n          <a-divider type=\"vertical\" style=\"background-color: #a8a7a7!important;\"/>\n          <a style=\"color: #e01735\">删除记录</a>\n        </span>\n          </div>\n        </template>\n      </a-table>\n    </div>\n  </div>\n</template>\n\n<script>\nimport RunNewman from \"@/components/Newman/RunNewman\";\nimport NewmanTask from \"@/components/Newman/NewmanTask\";\nimport {getNewmanTasks, putNewmanTasks} from \"@/api/request\";\n\nexport default {\n  name: \"Newman\",\n  components: {NewmanTask, RunNewman},\n  data() {\n    return {\n      taskCount: 0,\n      columns: [\n        {title: '名称', width: 150, dataIndex: 'name', scopedSlots: {customRender: 'name'}},\n        {title: '描述', width: 250, dataIndex: 'description', scopedSlots: {customRender: 'description'}},\n        {title: '状态', width: 50, dataIndex: 'status', key: 'status', scopedSlots: {customRender: 'status'}},\n        {title: '开始时间', width: 100, dataIndex: 'created_at', key: 'created_at'},\n        {title: '结束时间', width: 100, dataIndex: 'updated_at', key: 'updated_at'},\n        {title: 'Action', width: 200, dataIndex: '', key: 'x', scopedSlots: {customRender: 'action'}},\n      ],\n      paginationConfig: {\n        defaultCurrent: 1,\n        defaultPageSize: 5,\n      },\n      scriptData: [],\n      tableData: [],\n      cacheData: [],\n      filters: [],\n      filteredValue: [],\n      tagsFilterDropdownVisible: false,\n      openRunNewmanModelFlag: false,\n      openNewmanTaskModelFlag: false,\n      runTestFlag: false,\n      timer: null,\n      taskName: \"\",\n      // flag 代表任务打开与关闭\n      tempTaskLog: [\n        {\n          name: \"关闭测试环境的报错信息\",\n          flag: false,\n          status: \"\",\n          index: 1\n        },\n        {\n          name: \"导入备份及恢复数据库的测试接口\",\n          flag: false,\n          status: \"\",\n          index: 2\n        },\n        {\n          name: \"切换到测试环境\",\n          flag: false,\n          status: \"\",\n          index: 3\n        },\n        {\n          name: \"执行newman测试命令\",\n          flag: false,\n          status: \"\",\n          index: 4\n        }\n      ],\n      taskLog: [],\n      currentTask: null,\n      editingKey: '',\n    }\n  },\n  watch: {\n    currentTask: {\n      handler: function (newVal, oldVal) {\n        if (this.currentTask.status !== \"success\") {\n\n        }\n      },\n      // 深度观察监听\n      deep: true\n    }\n  },\n  created() {\n    this.getUnfinishedNewmanTasks()\n    this.getScriptData()\n  },\n  mounted() {\n    var currentTaskId = localStorage.getItem(\"run_postman_flag\");\n    if (currentTaskId == null){\n      localStorage.setItem('run_postman_flag',\"0\");\n    }\n    this.getAllTaskList();\n    // if (this.timer == null) {\n    //   this.timer = setInterval(() => {\n    //     this.getUnfinishedNewmanTasks()\n    //   }, 3000);\n    // }\n  },\n  beforeDestroy() {\n    clearInterval(this.timer);\n  },\n  methods: {\n    onSearch(value) {\n      console.log(value);\n    },\n    handleChange(pagination, filters) {\n      var tagFilterChecked = filters.tags\n      if (filters.tags.length === 0) {\n        this.tableData = this.scriptData\n        return\n      }\n      this.tableData = this.scriptData.filter(item => {\n        return item.tags.some(tag => tagFilterChecked.includes(tag.text));\n      })\n    },\n    getScriptData() {\n      this.scriptData = [\n        {\n          id: 1,\n          name: 'John Brown',\n          created_at: 'New York No. 1 Lake Park',\n          updated_at: 'New York No. 1 Lake Park',\n          description: 'My name is John Brown, I am 32 years old, living in New York No. 1 Lake Park.',\n        },\n        {\n          id: 2,\n          name: 'Jim Green',\n          created_at: 'New York No. 1 Lake Park',\n          updated_at: 'New York No. 1 Lake Park',\n          description: 'My name is Jim Green, I am 42 years old, living in London No. 1 Lake Park.',\n        },\n        {\n          id: 3,\n          name: 'Joe Black',\n          created_at: 'New York No. 1 Lake Park',\n          updated_at: 'New York No. 1 Lake Park',\n          description: 'My name is Joe Black, I am 32 years old, living in Sidney No. 1 Lake Park.',\n        },\n        {\n          id: 4,\n          name: 'Joe Black',\n          created_at: 'New York No. 1 Lake Park',\n          updated_at: 'New York No. 1 Lake Park',\n          description: 'My name is Joe Black, I am 32 years old, living in Sidney No. 1 Lake Park.',\n        }\n      ]\n\n      this.tableData = this.scriptData\n    },\n\n    openRunNewmanModel() {\n      this.openRunNewmanModelFlag = true\n    },\n    openNewmanTaskModel() {\n      this.openNewmanTaskModelFlag = true\n    },\n    getRunNewmanModelStatus(status) {\n      this.openRunNewmanModelFlag = status\n    },\n    getNewmanModelTaskStatus(status) {\n      this.openNewmanTaskModelFlag = status\n    },\n    getRunTaskObj(taskObj) {\n      if (taskObj != null) {\n        this.runTestFlag = true\n        console.log(taskObj)\n      }\n    },\n\n    // 获取全部任务列表\n    getAllTaskList(params){\n      if (params == null) {\n        params = \"\"\n      }\n      this.$request.getAllNewmanTasks(params).then(res => {\n        if (res.status === 200) {\n          this.backupList = res.data.data\n\n          const dbFilters = [];\n\n          this.backupList.forEach(item => {\n            const existingTag = dbFilters.find(filter => filter.text === item.db_name);\n            if (!existingTag) {\n              dbFilters.push({text: item.db_name, value: item.db_name});\n            }\n            item.key = item.id\n          })\n          this.columns.forEach(item => {\n            if (item.key === 'db_name') {\n              item.filters = dbFilters\n            }\n          })\n          this.tableData = this.backupList\n          this.cacheData = this.tableData.map(item => ({...item}));\n        }\n      })\n    },\n    // table编辑\n    handleChangeEdit(value, key, column) {\n      const newData = [...this.tableData];\n      const target = newData.find(item => key === item.key);\n\n      if (target) {\n        target[column] = value;\n        this.tableData = newData;\n      }\n    },\n    // 编辑表格基本信息\n    edit(key) {\n      const newData = [...this.tableData];\n      const target = newData.find(item => key === item.key);\n      this.editingKey = key;\n      if (target) {\n        target.editable = true;\n        this.tableData = newData;\n      }\n    },\n    save(key) {\n      const newData = [...this.tableData];\n      const newCacheData = [...this.cacheData];\n      const target = newData.find(item => key === item.key);\n      const targetCache = newCacheData.find(item => key === item.key);\n      if (target && targetCache) {\n        // 校验\n\n        let nameLength = target.name.length;\n        let descriptionLength = target.description.length;\n\n        if (!(nameLength >= 5 && length <= 50)) {\n          this.$message.warning(\"名称长度应该在5～50之间\")\n          return\n        }\n        if (descriptionLength === 0) {\n          this.$message.warning(\"描述不能为空\")\n          return\n        }\n        var param = {\n          data: {\n            id:target.id,\n            name:target.name,\n            description:target.description\n          }\n        }\n        this.$request.putNewmanTasks(param).then(res => {\n          if (res.status === 200) {\n            delete target.editable;\n            this.tableData = newData;\n            Object.assign(targetCache, target);\n            this.cacheData = newCacheData;\n            this.$message.success(\"更新成功\")\n          } else {\n            this.$message.error(\"更新失败\")\n          }\n        })\n      }\n      this.editingKey = '';\n    },\n    cancel(key) {\n      const newData = [...this.tableData];\n      const target = newData.find(item => key === item.key);\n      this.editingKey = '';\n      if (target) {\n        Object.assign(target, this.cacheData.find(item => key === item.key));\n        delete target.editable;\n        this.tableData = newData;\n      }\n    },\n\n\n    // 获取未完成的任务\n    getUnfinishedNewmanTasks() {\n      var param = \"?is_unfinished=true\"\n      this.$request.getNewmanTasks(param).then(async res => {\n        if (res.status === 200) {\n          var data = res.data.data\n          if (data.length !== 0) {\n            var task = data[0];\n            this.currentTask = task\n            this.taskName = task.name;\n            this.taskCount = 1;\n            if (task.log == null) {\n              var putParam = {data: {log: this.tempTaskLog, id: task.id}}\n              this.$request.putNewmanTasksLog(putParam).then(res => {\n                if (res.status === 200) {\n                  if (res.data.data.log != null && res.data.data.log.length !== 0) {\n                    this.taskLog = res.data.data.log\n                  } else {\n                    this.taskLog = []\n                  }\n                } else {\n                  this.taskLog = []\n                }\n              })\n            } else {\n              this.taskLog = task.log\n              // start\n              if (task.status == null) {\n                await this.startPostmanTest(this.taskLog)\n              }\n            }\n          } else {\n            this.currentTask = null\n            this.taskName = \"\";\n            this.taskCount = 0;\n            this.taskLog = []\n          }\n        }\n        setTimeout(this.getUnfinishedNewmanTasks, 3000);\n      });\n    },\n\n    async startPostmanTest(taskLog) {\n      for (let i = 0; i < taskLog.length; i++) {\n        var item = taskLog[i];\n        if (item.flag === false) { // 任务未开始\n          taskLog[i].flag = true // 开始任务\n          // 执行任务\n          if (item.index === 1) {// 关闭测试环境的报错信息\n            await this.$request.switchApi('test_env_error_message', false).then(async res => {\n              if (res.status === 200) { // 关闭成功\n                taskLog[i].status = \"success\"\n                await this.modifyTaskLog(this.taskLog, null, this.currentTask.id)\n              } else {\n                taskLog[i].status = \"error\"+res.data.message;\n                await this.modifyTaskLog(this.taskLog, \"error\", this.currentTask.id)\n              }\n\n            });\n          } else if (item.index === 2) { // 导入备份/恢复数据库的测试接口\n            await this.$request.switchApi('back_api', true).then(async res => {\n              if (res.status === 200) { // 关闭成功\n                taskLog[i].status = \"success\"\n                await this.modifyTaskLog(this.taskLog, null, this.currentTask.id)\n              } else {\n                taskLog[i].status = \"error\"+res.data.message;\n                await this.modifyTaskLog(this.taskLog, \"error\", this.currentTask.id)\n              }\n            });\n          } else if (item.index === 3) { // 切换到测试环境\n            await this.$request.switchApi('test_env', true).then(async res => {\n              if (res.status === 200) { // 关闭成功\n                taskLog[i].status = \"success\"\n                await this.modifyTaskLog(this.taskLog, null, this.currentTask.id)\n              } else {\n                taskLog[i].status = \"error\"+res.data.message;\n                await this.modifyTaskLog(this.taskLog, \"error\", this.currentTask.id)\n              }\n            });\n          } else if (item.index === 4) { // 执行postman测试，只执行一次\n            var currentTaskId = localStorage.getItem(\"run_postman_flag\");\n            if (currentTaskId != this.currentTask.id){\n              const param = {\n                data: {\n                  task_id: this.currentTask.id\n                }\n              };\n              await this.$request.runNewman(param).then(async res => {\n                if (res.status === 200) { // 执行成功\n                  localStorage.setItem(\"run_postman_flag\", this.currentTask.id);\n                } else {\n                  taskLog[i].status = \"error\"+res.data.message;\n                  await this.modifyTaskLog(this.taskLog, \"error\", this.currentTask.id);\n                }\n              });\n            }\n          }\n          break;\n        }\n      }\n    },\n    // 更新日志及状态\n    async modifyTaskLog(log, status, id) {\n      var putParam = {data: {log: log, status: status, id: id}}\n      await this.$request.putNewmanTasksLog(putParam).then()\n    },\n    initTaskLog() {\n      this.taskLog = [...this.tempTaskLog]\n    }\n  }\n}\n</script>\n\n<style scoped>\n\n\n.my-n-button {\n  margin-top: 10px;\n  display: flex;\n  justify-content: space-between;\n}\n\n.my-n-table {\n  margin-top: 10px;\n}\n</style>\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}