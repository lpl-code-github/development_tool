(self["webpackChunkclient"]=self["webpackChunkclient"]||[]).push([[787],{13787:function(t,e,a){"use strict";a.r(e),a.d(e,{default:function(){return _}});var s=function(){var t=this,e=t._self._c;return e("div",{staticClass:"my-newman"},[e("RunNewman",{attrs:{"open-flag":t.openRunNewmanModelFlag},on:{newmanTask:t.getRunTaskObj,updateModelStatus:t.getRunNewmanModelStatus}}),e("NewmanTask",{attrs:{"task-log":t.taskLog,taskName:t.taskName,"open-flag":t.openNewmanTaskModelFlag},on:{updateModelStatus:t.getNewmanModelTaskStatus}}),e("div",{staticClass:"my-n-button"},[e("a-input-search",{staticStyle:{width:"200px"},attrs:{placeholder:"输入操作名称或描述搜索"},on:{search:t.onSearch}}),e("div",[e("a-button",{staticStyle:{"margin-right":"10px"},attrs:{type:"primary"},on:{click:t.openRunNewmanModel}},[t._v(" 创建任务 ")]),e("a-badge",{staticStyle:{"margin-right":"10px"},attrs:{count:t.taskCount}},[e("a-button",{on:{click:t.openNewmanTaskModel}},[t._v(" 任务详情 "),0!==t.taskCount?e("a-icon",{attrs:{type:"sync",spin:""}}):t._e()],1)],1)],1)],1),e("div",{staticClass:"my-n-table"},[e("a-table",{attrs:{columns:t.columns,"data-source":t.tableData,pagination:t.paginationConfig},on:{change:t.handleChange},scopedSlots:t._u([t._l(["name","description"],(function(a){return{key:a,fn:function(s,n,i){return[e("div",{key:a},[n.editable?e("a-input",{staticStyle:{margin:"-5px 0"},attrs:{type:"description"===a?"textarea":"",rows:"1",value:s},on:{change:e=>t.handleChangeEdit(e.target.value,n.key,a)}}):[t._v(" "+t._s(""===s||null===s?"/":s)+" ")]],2)]}}})),{key:"status",fn:function(a){return e("span",{},[e("a-tag",{attrs:{color:"成功"===a?"#1ba81e":"#d92f09"}},[t._v(" "+t._s(a)+" ")])],1)}},{key:"action",fn:function(a,s,n){return[e("div",{staticClass:"editable-row-operations"},[s.editable?e("span",[e("a",{staticStyle:{color:"#5f92ef"},on:{click:()=>t.save(s.key)}},[t._v("更新")]),e("a-divider",{staticStyle:{"background-color":"#a8a7a7!important"},attrs:{type:"vertical"}}),e("a-popconfirm",{attrs:{title:"确定取消吗？"},on:{confirm:()=>t.cancel(s.key)}},[e("a",{staticStyle:{color:"#5f6062"}},[t._v("取消")])])],1):e("span",[e("a",{staticStyle:{color:"#5f92ef"},attrs:{disabled:""!==t.editingKey},on:{click:()=>t.edit(s.key)}},[t._v("编辑")]),e("a-divider",{staticStyle:{"background-color":"#a8a7a7!important"},attrs:{type:"vertical"}}),e("a",{staticStyle:{color:"#286d9f"},on:{click:function(e){return t.downloadFile(s.html_report_path)}}},[t._v("Html报告")]),e("a-divider",{staticStyle:{"background-color":"#a8a7a7!important"},attrs:{type:"vertical"}}),e("a",{staticStyle:{color:"#16750c"},on:{click:function(e){return t.downloadFile(s.excel_report_path)}}},[t._v("Excel报告")]),e("a-divider",{staticStyle:{"background-color":"#a8a7a7!important"},attrs:{type:"vertical"}}),e("a",{staticStyle:{color:"#e01735"},on:{click:function(e){return t.deleteNewmanTask(s.key)}}},[t._v("删除")])],1)])]}},{key:"expandedRowRender",fn:function(a){return e("p",{staticStyle:{margin:"0"}},[e("span",{staticStyle:{"font-weight":"bolder"}},[t._v("newman cli输出：")]),t._v("  "),e("a",{on:{click:function(e){return t.downloadFile(a.cli_output_path)}}},[t._v(t._s(a.cli_output_path))])])}}],null,!0)})],1)],1)},n=[],i=(a(57658),function(){var t=this,e=t._self._c;return e("div",[e("a-modal",{attrs:{title:"运行postman测试","on-ok":"handleOk",afterClose:t.afterClose,maskClosable:!1},model:{value:t.visible,callback:function(e){t.visible=e},expression:"visible"}},[e("template",{slot:"footer"},[e("a-button",{key:"back",on:{click:t.handleCancel}},[t._v(" 取消 ")]),e("a-button",{key:"submit",attrs:{type:"primary",loading:t.loading},on:{click:t.handleOk}},[t._v(" 提交 ")])],1),e("a-form-model",{ref:"ruleForm",staticStyle:{width:"100%"},attrs:{model:t.form,rules:t.rules,"label-col":{span:3},"wrapper-col":{span:20}}},[e("a-form-model-item",{ref:"name",attrs:{label:"名称",prop:"name"}},[e("a-input",{model:{value:t.form.name,callback:function(e){t.$set(t.form,"name",e)},expression:"form.name"}})],1),e("a-form-model-item",{attrs:{label:"描述",prop:"description"}},[e("a-input",{attrs:{rows:"4",type:"textarea"},model:{value:t.form.description,callback:function(e){t.$set(t.form,"description",e)},expression:"form.description"}})],1)],1)],2)],1)}),o=[],l={name:"RunNewman",props:{openFlag:{type:Boolean,required:!0}},data(){return{loading:!1,visible:!1,formLayout:"horizontal",form:{name:"",description:""},rules:{name:[{required:!0,message:"请输入操作名称",trigger:"blur"},{min:5,max:50,message:"长度必须在 5 ～ 50",trigger:"blur"}]}}},watch:{openFlag:{handler:function(t,e){this.visible=t},deep:!0}},mounted(){this.visible=this.openFlag},methods:{handleOk(t){this.$createElement;this.loading=!0,this.$refs.ruleForm.validate((t=>{if(!t)return this.loading=!1,!1;this.$confirm({title:"在创建测试任务前需要和您确认",content:t=>t("div",{style:"color:red;"},["您当前数据库是否符合测试环境?"]),okText:"是的，创建任务",cancelText:"去导入数据库",onOk:()=>{var t={data:this.form};this.$request.postNewmanTasks(t).then((t=>{200===t.status?(this.$emit("newmanTask",t.data.data),this.$message.success("创建测试任务成功，请到任务详情查看")):this.$message.error("创建测试失败")})),setTimeout((()=>{this.$emit("updateModelStatus",!1),this.loading=!1,this.initFormData()}),2)},onCancel:()=>{this.$router.push("/backup")}})}))},handleCancel(t){this.$emit("updateModelStatus",!1)},afterClose(t){this.$emit("updateModelStatus",!1)},initFormData(){this.$refs.ruleForm.resetFields()}}},r=l,d=a(1001),u=(0,d.Z)(r,i,o,!1,null,"c9b03810",null),c=u.exports,h=function(){var t=this,e=t._self._c;return e("div",[e("a-modal",{attrs:{title:"当前测试任务","on-ok":"handleOk",footer:null,afterClose:t.afterClose,maskClosable:!1},model:{value:t.visible,callback:function(e){t.visible=e},expression:"visible"}},[null!=t.taskName&&void 0!==t.taskName&&""!==t.taskName?e("div",[e("span",{staticStyle:{"font-weight":"bolder"}},[t._v("任务名称：")]),t._v(" "),e("span",[t._v(" "+t._s(t.taskName))]),e("div",{staticStyle:{"margin-top":"30px"}},[e("a-timeline",t._l(t.taskLog,(function(a,s){return e("a-timeline-item",{key:a.index,attrs:{pendingDot:!0,color:t.computedColor(a)}},[a.flag&&""===a.status?e("a-icon",{staticStyle:{"font-size":"16px"},attrs:{slot:"dot",type:"loading"},slot:"dot"}):t._e(),t._v(" "+t._s(a.name)+"   "),""!==a.status?e("span",[t._v(" 状态："+t._s(a.status))]):t._e()],1)})),1)],1)]):e("a-empty")],1)],1)},m=[],k={name:"NewmanTask",props:{openFlag:{type:Boolean,required:!0},taskName:{type:String,required:!0},taskLog:{type:Array,required:!0}},data(){return{loading:!1,visible:!1}},computed:{computedColor(){return function(t){return t.flag&&"成功"===t.status?"green":t.flag||""!==t.status?"blue":"gray"}}},watch:{openFlag:{handler:function(t,e){this.visible=t},deep:!0}},mounted(){this.visible=this.openFlag},methods:{afterClose(t){this.$emit("updateModelStatus",!1)}}},g=k,p=(0,d.Z)(g,h,m,!1,null,"b6e3aa3a",null),f=p.exports,w=a(35823),y=a.n(w),v=(a(19410),{name:"Newman",components:{NewmanTask:f,RunNewman:c},data(){return{taskCount:0,columns:[{title:"名称",width:150,dataIndex:"name",scopedSlots:{customRender:"name"}},{title:"描述",width:250,dataIndex:"description",scopedSlots:{customRender:"description"}},{title:"状态",width:50,dataIndex:"status",key:"status",scopedSlots:{customRender:"status"}},{title:"开始时间",width:100,dataIndex:"created_at",key:"created_at",sorter:(t,e)=>new Date(t.created_at)-new Date(e.created_at)},{title:"结束时间",width:100,dataIndex:"updated_at",key:"updated_at",sorter:(t,e)=>new Date(t.created_at)-new Date(e.created_at)},{title:"Action",width:200,dataIndex:"",key:"x",scopedSlots:{customRender:"action"}}],paginationConfig:{defaultCurrent:1,defaultPageSize:5},newmanTaskList:[],tableData:[],cacheData:[],filters:[],filteredValue:[],openRunNewmanModelFlag:!1,openNewmanTaskModelFlag:!1,runTestFlag:!1,taskName:"",tempTaskLog:[{name:"关闭测试环境的报错信息",flag:!1,status:"",index:1},{name:"导入备份及恢复数据库的测试接口",flag:!1,status:"",index:2},{name:"切换到测试环境",flag:!1,status:"",index:3},{name:"执行newman测试命令",flag:!1,status:"",index:4}],taskLog:[],currentTask:null,editingKey:""}},watch:{currentTask:{handler:function(t,e){null!==e&&null===t&&this.getAllTaskList()},deep:!0}},created(){this.getUnfinishedNewmanTasks(),this.getAllTaskList()},mounted(){var t=localStorage.getItem("run_postman_flag");null==t&&localStorage.setItem("run_postman_flag","0")},methods:{handleChange(t,e){var a=e.status;if(void 0!==e.status&&0===e.status.length){this.tableData=this.newmanTaskList;var s=this.columns;return s.forEach((t=>{"status"===t.key&&this.$set(t,"filteredValue",[])})),void this.$set(this,"columns",[...s])}if(void 0!==a){this.tableData=this.newmanTaskList.filter((t=>a.includes(t.status)));s=this.columns;s.forEach((t=>{"status"===t.key&&this.$set(t,"filteredValue",a)})),this.$set(this,"columns",[...s])}},handleChangeEdit(t,e,a){const s=[...this.tableData],n=s.find((t=>e===t.key));n&&(n[a]=t,this.tableData=s)},edit(t){const e=[...this.tableData],a=e.find((e=>t===e.key));this.editingKey=t,a&&(a.editable=!0,this.tableData=e)},save(t){const e=[...this.tableData],a=[...this.cacheData],s=e.find((e=>t===e.key)),n=a.find((e=>t===e.key));if(s&&n){let t=s.name.length,o=s.description.length;if(!(t>=5&&t<=50))return void this.$message.warning("名称长度应该在5～50之间");if(0===o)return void this.$message.warning("描述不能为空");var i={data:{id:s.id,name:s.name,description:s.description}};this.$request.putNewmanTasks(i).then((t=>{200===t.status?(delete s.editable,this.tableData=e,Object.assign(n,s),this.cacheData=a,this.$message.success("更新成功")):this.$message.error("更新失败")}))}this.editingKey=""},cancel(t){const e=[...this.tableData],a=e.find((e=>t===e.key));this.editingKey="",a&&(Object.assign(a,this.cacheData.find((e=>t===e.key))),delete a.editable,this.tableData=e)},deleteNewmanTask(t){this.$confirm({title:"确认删除测试记录吗?",content:"将会删除您的html报告、Excel报告等",okText:"删除",okType:"danger",cancelText:"不了",onOk:()=>{var e=this.cacheData.find((e=>t===e.key)),a={data:{id:e.id}};this.$request.deleteNewmanTasks(a).then((e=>{if(200===e.status){const e=[...this.newmanTaskList];this.newmanTaskList=e.filter((e=>e.key!==t)),this.tableData=[...this.newmanTaskList],this.$message.success("删除成功");const s=[];this.newmanTaskList.forEach((t=>{const e=s.find((e=>e.text===t.status));e||s.push({text:t.status,value:t.status}),t.key=t.id}));var a=this.columns;a.forEach((t=>{"status"===t.key&&(t.filters=[...s],this.$set(t,"filteredValue",[]))})),this.$set(this,"columns",[...a]),this.cacheData=this.tableData.map((t=>({...t})))}else this.$message.error("删除失败")}))},onCancel(){console.log("Cancel")}})},onSearch(t){var e="?key="+t;this.getAllTaskList(e)},getAllTaskList(t){null==t&&(t=""),this.$request.getNewmanTasks(t).then((t=>{if(200===t.status){this.newmanTaskList=t.data.data;const e=[];this.newmanTaskList.forEach((t=>{const a=e.find((e=>e.text===t.status));a||e.push({text:t.status,value:t.status}),t.key=t.id})),this.columns.forEach((t=>{"status"===t.key&&(t.filters=e)})),this.tableData=[...this.newmanTaskList],this.cacheData=this.tableData.map((t=>({...t})))}}))},getUnfinishedNewmanTasks(){var t="?is_unfinished=true";this.$request.getNewmanTasks(t).then((async t=>{if(200===t.status){var e=t.data.data;if(0!==e.length){var a=e[0];if(sessionStorage.setItem("currentTask",a.id),this.currentTask=a,this.taskName=a.name,this.taskCount=1,null==a.log){var s={data:{log:this.tempTaskLog,id:a.id}};this.$request.putNewmanTasks(s).then((t=>{200===t.status&&null!=t.data.data.log&&0!==t.data.data.log.length?this.taskLog=t.data.data.log:this.taskLog=[]}))}else this.taskLog=a.log,null==a.status&&await this.startPostmanTest(this.taskLog)}else sessionStorage.removeItem("currentTask"),this.currentTask=null,this.taskName="",this.taskCount=0,this.taskLog=[]}"/newman"!==this.$route.path&&null===sessionStorage.getItem("currentTask")||setTimeout(this.getUnfinishedNewmanTasks,3e3)}))},async startPostmanTest(t){for(let s=0;s<t.length;s++){var e=t[s];if(!1===e.flag){if(t[s].flag=!0,1===e.index)await this.$request.switchApi("test_env_error_message",!1).then((async e=>{200===e.status?(t[s].status="成功",await this.modifyTaskLog(this.taskLog,null,this.currentTask.id)):(t[s].status="error"+e.message,await this.modifyTaskLog(this.taskLog,"error",this.currentTask.id))}));else if(2===e.index)await this.$request.switchApi("back_api",!0).then((async e=>{200===e.status?(t[s].status="成功",await this.modifyTaskLog(this.taskLog,null,this.currentTask.id)):(t[s].status="error"+e.message,await this.modifyTaskLog(this.taskLog,"error",this.currentTask.id))}));else if(3===e.index)await this.$request.switchApi("test_env",!0).then((async e=>{200===e.status?(t[s].status="成功",await this.modifyTaskLog(this.taskLog,null,this.currentTask.id)):(t[s].status="error"+e.message,await this.modifyTaskLog(this.taskLog,"error",this.currentTask.id))}));else if(4===e.index){var a=localStorage.getItem("run_postman_flag");if(a!=this.currentTask.id){const e={data:{task_id:this.currentTask.id}};await this.$request.runNewman(e).then((async e=>{200===e.status?localStorage.setItem("run_postman_flag",this.currentTask.id):(t[s].status="error"+e.message,await this.modifyTaskLog(this.taskLog,"error",this.currentTask.id))}))}}break}}},async modifyTaskLog(t,e,a){var s={data:{log:t,status:e,id:a}};await this.$request.putNewmanTasks(s).then()},openRunNewmanModel(){this.openRunNewmanModelFlag=!0},openNewmanTaskModel(){this.openNewmanTaskModelFlag=!0},getRunNewmanModelStatus(t){this.openRunNewmanModelFlag=t},getNewmanModelTaskStatus(t){this.openNewmanTaskModelFlag=t},getRunTaskObj(t){null!=t&&(this.runTestFlag=!0)},downloadFile(t){let e=t.substring(t.lastIndexOf("/")+1);this.$request.downloadFile(t).then((t=>{if(200===t.status)y()(t.data,e);else{const t=e.includes("html"),a=e.includes(".csv"),s=e.includes(".txt");console.log(a),(t||a)&&this.$message.error("文件可能丢失，也可能不存在，详情请下载cli报告看"),s&&this.$message.error("cli报告文件已经丢失")}}))}}}),b=v,T=(0,d.Z)(b,s,n,!1,null,"a75728c8",null),_=T.exports},35823:function(t){t.exports=function(t,e,a,s){var n="undefined"!==typeof s?[s,t]:[t],i=new Blob(n,{type:a||"application/octet-stream"});if("undefined"!==typeof window.navigator.msSaveBlob)window.navigator.msSaveBlob(i,e);else{var o=window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(i):window.webkitURL.createObjectURL(i),l=document.createElement("a");l.style.display="none",l.href=o,l.setAttribute("download",e),"undefined"===typeof l.download&&l.setAttribute("target","_blank"),document.body.appendChild(l),l.click(),setTimeout((function(){document.body.removeChild(l),window.URL.revokeObjectURL(o)}),200)}}}}]);