(self["webpackChunkclient"]=self["webpackChunkclient"]||[]).push([[205],{13205:function(t,e,a){"use strict";a.r(e),a.d(e,{default:function(){return k}});var i=function(){var t=this,e=t._self._c;return e("div",[e("AddBackUp",{attrs:{"open-flag":t.openAddScriptModel,"db-list":t.dbList},on:{updateModelStatus:t.getModelStatus,submit:t.updateTable}}),e("div",{staticClass:"my-b-button"},[e("a-input-search",{staticStyle:{width:"200px"},attrs:{placeholder:"输入名称或描述搜索"},on:{search:t.onSearch}}),e("a-button",{attrs:{type:"primary"},on:{click:t.backUp}},[t._v(" 新增备份 ")])],1),e("div",{staticClass:"my-s-table"},[e("a-table",{key:t.componentKey,staticStyle:{height:"40vh"},attrs:{columns:t.columns,"data-source":t.tableData,pagination:t.paginationConfig,scrollToFirstRowOnChange:!0},on:{change:t.handleChange},scopedSlots:t._u([t._l(["name","description"],(function(a){return{key:a,fn:function(i,s,n){return[e("div",{key:a},[s.editable?e("a-input",{staticStyle:{margin:"-5px 0"},attrs:{type:"description"===a?"textarea":"",rows:"1",value:i},on:{change:e=>t.handleChangeEdit(e.target.value,s.key,a)}}):[t._v(" "+t._s(""===i||null===i?"/":i)+" ")]],2)]}}})),{key:"action",fn:function(a,i,s){return[e("div",{staticClass:"editable-row-operations"},[i.editable?e("span",[e("a",{staticStyle:{color:"#5f92ef"},on:{click:()=>t.save(i.key)}},[t._v("更新")]),e("a-divider",{staticStyle:{"background-color":"#a8a7a7!important"},attrs:{type:"vertical"}}),e("a-popconfirm",{attrs:{title:"确定取消吗？"},on:{confirm:()=>t.cancel(i.key)}},[e("a",{staticStyle:{color:"#5f6062"}},[t._v("取消")])])],1):e("span",[e("a",{staticStyle:{color:"#5f92ef"},attrs:{disabled:""!==t.editingKey},on:{click:()=>t.edit(i.key)}},[t._v("编辑")]),e("a-divider",{staticStyle:{"background-color":"#a8a7a7!important"},attrs:{type:"vertical"}}),e("a",{staticStyle:{color:"#16750c"},attrs:{disabled:""!==t.editingKey},on:{click:()=>t.importDb(i.key)}},[t._v("导入")]),e("a-divider",{staticStyle:{"background-color":"#a8a7a7!important"},attrs:{type:"vertical"}}),e("a",{staticStyle:{color:"#e01735"},attrs:{disabled:""!==t.editingKey},on:{click:()=>t.deleteDatabaseBackup(i.key)}},[t._v("删除")])],1)])]}},{key:"expandedRowRender",fn:function(a){return e("p",{staticStyle:{margin:"0"}},[e("span",{staticStyle:{"font-weight":"bolder"}},[t._v("SQL文件路径：")]),t._v(" "),e("a",{on:{click:function(e){return t.downloadSQLFile(a.path)}}},[t._v(t._s(a.path))])])}}],null,!0)})],1)],1)},s=[],n=(a(57658),function(){var t=this,e=t._self._c;return e("div",[e("a-modal",{attrs:{title:"备份数据库","on-ok":"handleOk",afterClose:t.afterClose,maskClosable:!1},model:{value:t.visible,callback:function(e){t.visible=e},expression:"visible"}},[e("template",{slot:"footer"},[e("a-button",{key:"back",on:{click:t.handleCancel}},[t._v(" 取消 ")]),e("a-button",{key:"submit",attrs:{type:"primary",loading:t.loading},on:{click:t.handleOk}},[t._v(" 提交 ")])],1),e("a-form-model",{ref:"ruleForm",staticStyle:{width:"100%"},attrs:{model:t.form,rules:t.rules,"label-col":{span:3},"wrapper-col":{span:20}}},[e("a-form-model-item",{ref:"name",attrs:{label:"名称",prop:"name"}},[e("a-input",{model:{value:t.form.name,callback:function(e){t.$set(t.form,"name",e)},expression:"form.name"}})],1),e("a-form-model-item",{attrs:{label:"描述",prop:"desc"}},[e("a-input",{attrs:{rows:"4",type:"textarea"},model:{value:t.form.desc,callback:function(e){t.$set(t.form,"desc",e)},expression:"form.desc"}})],1),e("a-form-model-item",{attrs:{label:"DB",prop:"db"}},[e("a-select",{attrs:{"show-search":"",placeholder:"选择数据库","option-filter-prop":"children","filter-option":t.filterOption},model:{value:t.form.db,callback:function(e){t.$set(t.form,"db",e)},expression:"form.db"}},t._l(t.dbList,(function(a,i){return e("a-select-option",{key:i,attrs:{value:a}},[t._v(" "+t._s(a)+" ")])})),1)],1)],1)],2)],1)}),o=[],l={name:"AddBackUp",props:{openFlag:{type:Boolean,required:!0},dbList:{type:Array,required:!0}},data(){return{loading:!1,visible:!1,formLayout:"horizontal",form:{name:"",desc:"",db:""},rules:{name:[{required:!0,message:"请输入操作名称",trigger:"blur"},{min:5,max:50,message:"长度必须在 5 ～ 50",trigger:"blur"}],db:[{required:!0,message:"请选择数据库",trigger:"blur"}]}}},watch:{openFlag:{handler:function(t,e){this.visible=t},deep:!0}},mounted(){this.visible=this.openFlag},methods:{handleOk(t){this.loading=!0,this.$refs.ruleForm.validate((t=>{if(!t)return this.loading=!1,!1;var e={data:this.form},a=this.$message,i=a.loading("正在备份数据库，该操作有点耗时，请等待....",0);this.$request.postDatabaseBackup(e).then((t=>{200===t.status?(setTimeout(i,0),a.success("备份成功"),this.$emit("submit",t.data.data)):setTimeout(i,0)})),this.initFormData(),setTimeout((()=>{this.$emit("updateModelStatus",!1),this.loading=!1}),1)}))},handleCancel(t){this.initFormData(),this.$emit("updateModelStatus",!1)},afterClose(t){this.initFormData(),this.$emit("updateModelStatus",!1)},filterOption(t,e){return e.componentOptions.children[0].text.toLowerCase().indexOf(t.toLowerCase())>=0},initFormData(){this.$refs.ruleForm.resetFields()}}},r=l,d=a(1001),c=(0,d.Z)(r,n,o,!1,null,"4a0d327e",null),u=c.exports,h=a(35823),m=a.n(h),p={name:"Backup",components:{AddBackUp:u},data(){return{openAddScriptModel:!1,dbList:[],getDatabaseListFlag:!1,columns:[{title:"名称",width:200,dataIndex:"name",scopedSlots:{customRender:"name"}},{title:"描述",width:350,dataIndex:"description",scopedSlots:{customRender:"description"}},{title:"数据库",width:200,dataIndex:"db_name",key:"db_name",filters:[],filteredValue:[]},{title:"创建时间",width:150,dataIndex:"created_at",key:"created_at",sorter:(t,e)=>new Date(t.created_at)-new Date(e.created_at)},{title:"Action",dataIndex:"",key:"x",scopedSlots:{customRender:"action"}}],backupList:[],paginationConfig:{defaultCurrent:1,defaultPageSize:5},tableData:[],cacheData:[],editingKey:"",componentKey:0}},created(){this.getBackupList()},methods:{handleChange(t,e){var a=e.db_name;if(void 0!==e.db_name&&0===e.db_name.length){this.tableData=this.backupList;var i=this.columns;return i.forEach((t=>{"db_name"===t.key&&this.$set(t,"filteredValue",[])})),void this.$set(this,"columns",[...i])}if(void 0!==a){this.tableData=this.backupList.filter((t=>a.includes(t.db_name)));i=this.columns;i.forEach((t=>{"db_name"===t.key&&this.$set(t,"filteredValue",a)})),this.$set(this,"columns",[...i])}},async backUp(){await this.getDatabaseList(),this.getDatabaseListFlag?this.openAddScriptModel=!0:this.$message.error("获取数据库列表失败")},onSearch(t){var e="?key="+t;this.getBackupList(e)},getBackupList(t){null==t&&(t=""),this.$request.getDatabaseBackup(t).then((t=>{if(200===t.status){this.backupList=t.data.data;const e=[];this.backupList.forEach((t=>{const a=e.find((e=>e.text===t.db_name));a||e.push({text:t.db_name,value:t.db_name}),t.key=t.id})),this.columns.forEach((t=>{"db_name"===t.key&&(t.filters=e)})),this.tableData=[...this.backupList],this.cacheData=this.tableData.map((t=>({...t})))}}))},async getDatabaseList(){await this.$request.getDatabaseList().then((t=>{200===t.status?(this.dbList=t.data.data,this.getDatabaseListFlag=!0):this.getDatabaseListFlag=!1}))},getModelStatus(t){this.openAddScriptModel=t},updateTable(t){if(null!==t){var e=t[0];e.key=e.id,this.backupList.unshift(e),this.$set(this,"backupList",[...this.backupList]);var a=this.columns;a.forEach((t=>{if("db_name"===t.key){var a=[...t.filters];const i=a.find((t=>t.text===e.db_name));i||a.push({text:e.db_name,value:e.db_name}),t.filters=a}})),this.$set(this,"columns",[...a]),this.tableData=[...this.backupList],this.cacheData=this.tableData.map((t=>({...t})))}},handleChangeEdit(t,e,a){const i=[...this.tableData],s=i.find((t=>e===t.key));s&&(s[a]=t,this.tableData=i)},edit(t){const e=[...this.tableData],a=e.find((e=>t===e.key));this.editingKey=t,a&&(a.editable=!0,this.tableData=e)},save(t){const e=[...this.tableData],a=[...this.cacheData],i=e.find((e=>t===e.key)),s=a.find((e=>t===e.key));if(i&&s){let t=i.name.length;if(!(t>=5&&t<=50))return void this.$message.warning("名称长度应该在5～50之间");var n={data:{id:i.id,name:i.name,description:i.description}};this.$request.putDatabaseBackup(n).then((t=>{200===t.status?(delete i.editable,this.tableData=e,Object.assign(s,i),this.cacheData=a,this.$message.success("更新成功")):this.$message.error("更新失败")}))}this.editingKey=""},cancel(t){const e=[...this.tableData],a=e.find((e=>t===e.key));this.editingKey="",a&&(Object.assign(a,this.cacheData.find((e=>t===e.key))),delete a.editable,this.tableData=e)},importDb(t){this.$createElement;this.$confirm({title:"确认导入数据库吗？",content:t=>t("div",{style:"color:red;"},["这将会覆盖您当前的数据库"]),okText:"导入",cancelText:"不了",onOk:()=>{var e=this.$message,a=this.cacheData.find((e=>t===e.key)),i={data:{id:a.id}},s=e.loading("正在导入数据库，该操作有点耗时，请等待....",0);this.$request.importDatabaseBackup(i).then((t=>{200===t.status?(e.success("导入成功"),setTimeout(s,0)):setTimeout(s,0)}))},onCancel(){console.log("Cancel")},class:"test"})},deleteDatabaseBackup(t){this.$confirm({title:"确认删除备份吗?",content:"将会删除您的SQL备份文件",okText:"删除",okType:"danger",cancelText:"不了",onOk:()=>{var e=this.cacheData.find((e=>t===e.key)),a={data:{id:e.id}};this.$request.deleteDatabaseBackup(a).then((e=>{if(200===e.status){const e=[...this.backupList];this.backupList=e.filter((e=>e.key!==t)),this.tableData=[...this.backupList],this.$message.success("删除成功");const i=[];this.backupList.forEach((t=>{const e=i.find((e=>e.text===t.db_name));e||i.push({text:t.db_name,value:t.db_name}),t.key=t.id}));var a=this.columns;a.forEach((t=>{"db_name"===t.key&&(t.filters=[...i],this.$set(t,"filteredValue",[]))})),this.$set(this,"columns",[...a]),this.cacheData=this.tableData.map((t=>({...t})))}else this.$message.error("删除失败")}))},onCancel(){console.log("Cancel")}})},downloadSQLFile(t){let e=t.substring(t.lastIndexOf("/")+1);this.$request.downloadFile(t).then((t=>{200===t.status&&m()(t.data,e)}))}}},b=p,f=(0,d.Z)(b,i,s,!1,null,"14a97751",null),k=f.exports},35823:function(t){t.exports=function(t,e,a,i){var s="undefined"!==typeof i?[i,t]:[t],n=new Blob(s,{type:a||"application/octet-stream"});if("undefined"!==typeof window.navigator.msSaveBlob)window.navigator.msSaveBlob(n,e);else{var o=window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(n):window.webkitURL.createObjectURL(n),l=document.createElement("a");l.style.display="none",l.href=o,l.setAttribute("download",e),"undefined"===typeof l.download&&l.setAttribute("target","_blank"),document.body.appendChild(l),l.click(),setTimeout((function(){document.body.removeChild(l),window.URL.revokeObjectURL(o)}),200)}}}}]);